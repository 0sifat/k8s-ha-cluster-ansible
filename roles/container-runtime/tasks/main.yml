---
- name: Check containerd status
  systemd:
    name: containerd
  register: containerd_status
  ignore_errors: yes

- name: Debug containerd status
  debug:
    var: containerd_status

- name: Check containerd socket
  stat:
    path: /var/run/containerd/containerd.sock
  register: containerd_socket

- name: Debug containerd socket
  debug:
    var: containerd_socket

- name: Restart containerd if not running
  systemd:
    name: containerd
    state: restarted
  when: containerd_status.ActiveState != "active"

- name: Configure containerd for Kubernetes
  block:
    - name: Ensure containerd config directory exists
      file:
        path: /etc/containerd
        state: directory
        mode: '0755'

    - name: Generate containerd config
      shell: containerd config default
      register: containerd_default_config
      changed_when: false

    - name: Create containerd config with proper CRI settings
      copy:
        content: |
          version = 2
          root = "/var/lib/containerd"
          state = "/run/containerd"
          [grpc]
            address = "/run/containerd/containerd.sock"
          [metrics]
            address = ""
          [plugins]
            [plugins."io.containerd.grpc.v1.cri"]
              stream_server_address = "127.0.0.1"
              stream_server_port = "0"
              enable_selinux = false
              sandbox_image = "registry.k8s.io/pause:3.9"
              [plugins."io.containerd.grpc.v1.cri".containerd]
                snapshotter = "overlayfs"
                default_runtime_name = "runc"
                [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
                  runtime_type = "io.containerd.runc.v2"
                  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
                    SystemdCgroup = true
              [plugins."io.containerd.grpc.v1.cri".cni]
                bin_dir = "/opt/cni/bin"
                conf_dir = "/etc/cni/net.d"
        dest: /etc/containerd/config.toml
        mode: '0644'

    - name: Restart containerd with new config
      systemd:
        name: containerd
        state: restarted

    - name: Wait for containerd socket
      wait_for:
        path: /var/run/containerd/containerd.sock
        state: present
        timeout: 30

    - name: Test containerd
      shell: ctr version
      register: ctr_test
      ignore_errors: yes

    - name: Debug containerd test
      debug:
        var: ctr_test
  when: containerd_status.ActiveState != "active" or not containerd_socket.stat.exists