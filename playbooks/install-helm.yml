---
- name: Install Helm on master nodes
  hosts: masters[0]
  become: yes

  tasks:
    - name: Check if Helm is already installed
      command: helm version
      register: helm_check
      ignore_errors: yes
      changed_when: false

    - name: Download and install Helm
      shell: |
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        chmod 700 get_helm.sh
        ./get_helm.sh
        rm get_helm.sh
      args:
        creates: /usr/local/bin/helm
      when: helm_check.rc != 0

    - name: Verify Helm installation
      command: helm version
      register: helm_version

    - name: Display Helm version
      debug:
        var: helm_version.stdout

    - name: Initialize Helm (if needed)
      command: helm repo add stable https://charts.helm.sh/stable
      when: helm_check.rc != 0