---
- name: Setup Kubernetes components on additional master nodes
  hosts: masters[1:]
  become: yes

  tasks:
    - name: Check if kubeadm is already installed
      command: which kubeadm
      register: kubeadm_check
      ignore_errors: yes
      changed_when: false

    - name: Install Kubernetes components if not present
      block:
        - name: Update apt cache
          apt:
            update_cache: yes

        - name: Install required packages
          apt:
            name:
              - curl
              - gnupg
            state: present

        - name: Add Kubernetes GPG key
          shell: |
            curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
          args:
            creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

        - name: Add Kubernetes repository
          shell: |
            echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /" | tee /etc/apt/sources.list.d/kubernetes.list
          args:
            creates: /etc/apt/sources.list.d/kubernetes.list

        - name: Update apt cache after adding repo
          apt:
            update_cache: yes

        - name: Install Kubernetes components
          apt:
            name:
              - kubelet=1.30.2-1.1
              - kubeadm=1.30.2-1.1
              - kubectl=1.30.2-1.1
            state: present
            force_apt_get: yes

        - name: Prevent automatic updates of Kubernetes packages
          command: apt-mark hold kubelet kubeadm kubectl

      when: kubeadm_check.rc != 0

    - name: Ensure kubelet is enabled
      systemd:
        name: kubelet
        enabled: yes
        state: started

    - name: Disable swap immediately
      command: swapoff -a
      ignore_errors: yes

    - name: Comment out swap in fstab
      lineinfile:
        path: /etc/fstab
        regexp: '^[^#].*swap'
        line: '# \0'
        backrefs: yes

    - name: Load required kernel modules
      command: modprobe {{ item }}
      loop:
        - overlay
        - br_netfilter

    - name: Ensure kernel modules load on boot
      lineinfile:
        path: /etc/modules-load.d/k8s.conf
        line: "{{ item }}"
        create: yes
      loop:
        - overlay
        - br_netfilter

    - name: Configure sysctl parameters
      lineinfile:
        path: /etc/sysctl.d/k8s.conf
        line: "{{ item.key }} = {{ item.value }}"
        create: yes
      loop:
        - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { key: 'net.ipv4.ip_forward', value: '1' }

    - name: Apply sysctl settings
      command: sysctl --system

    - name: Verify kubeadm is installed
      command: kubeadm version
      register: kubeadm_version
      ignore_errors: yes

    - name: Display installation status
      debug:
        msg: "Kubernetes components installed successfully - kubeadm is available"
      when: kubeadm_version.rc == 0

    - name: Check kubeadm installation alternative
      command: which kubeadm
      register: kubeadm_which
      ignore_errors: yes

    - name: Final installation verification
      debug:
        msg: "kubeadm installation verified: {{ 'SUCCESS' if kubeadm_which.rc == 0 else 'FAILED' }}"