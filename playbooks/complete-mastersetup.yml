---
- name: Complete setup for additional master nodes
  hosts: masters[1:]
  become: yes

  tasks:
    - name: Check if containerd is running
      systemd:
        name: containerd
        state: started
      register: containerd_status
      ignore_errors: yes

    - name: Install and configure containerd if needed
      block:
        - name: Update apt cache
          apt:
            update_cache: yes

        - name: Install containerd
          apt:
            name: containerd
            state: present

        - name: Create containerd config directory
          file:
            path: /etc/containerd
            state: directory
            mode: '0755'

        - name: Generate containerd config
          command: containerd config default
          register: containerd_config

        - name: Save containerd config
          copy:
            content: "{{ containerd_config.stdout }}"
            dest: /etc/containerd/config.toml
            mode: '0644'

        - name: Enable systemd cgroup
          replace:
            path: /etc/containerd/config.toml
            regexp: '            SystemdCgroup = false'
            replace: '            SystemdCgroup = true'

        - name: Start containerd
          systemd:
            name: containerd
            state: started
            enabled: yes
            daemon_reload: yes

      when: containerd_status is failed or containerd_status.failed

    - name: Wait for containerd socket
      wait_for:
        path: /var/run/containerd/containerd.sock
        timeout: 30

    - name: Restart kubelet
      systemd:
        name: kubelet
        state: restarted

    - name: Wait a moment for kubelet
      pause:
        seconds: 10

    - name: Check if node is already joined
      command: kubectl get nodes {{ inventory_hostname }}
      register: node_check
      delegate_to: "{{ groups['masters'][0] }}"
      ignore_errors: yes
      changed_when: false

    - name: Set node joined fact
      set_fact:
        node_joined: "{{ node_check.rc == 0 }}"

    - name: Get join command from first master
      command: kubeadm token create --print-join-command
      register: join_command
      delegate_to: "{{ groups['masters'][0] }}"
      run_once: true
      when: not node_joined

    - name: Extract certificate key from first master
      command: kubeadm init phase upload-certs --upload-certs
      register: cert_key
      delegate_to: "{{ groups['masters'][0] }}"
      run_once: true
      when: not node_joined

    - name: Parse certificate key
      set_fact:
        certificate_key: "{{ cert_key.stdout | regex_search('Using certificate key:\\s*([a-f0-9]+)', '\\1') | first }}"
      run_once: true
      when: not node_joined

    - name: Create master join command
      set_fact:
        master_join_cmd: "{{ join_command.stdout }} --control-plane --certificate-key {{ certificate_key }}"
      run_once: true
      when: not node_joined

    - name: Join additional master node
      command: "{{ master_join_cmd }}"
      when: not node_joined
      async: 600
      poll: 10

    - name: Wait for node to be ready
      command: kubectl wait --for=condition=Ready node/{{ inventory_hostname }} --timeout=300s
      delegate_to: "{{ groups['masters'][0] }}"
      when: not node_joined
      retries: 10
      delay: 10

    - name: Setup kubeconfig
      block:
        - name: Create .kube directory
          file:
            path: /root/.kube
            state: directory
            mode: '0700'

        - name: Copy kubeconfig
          copy:
            src: /etc/kubernetes/admin.conf
            dest: /root/.kube/config
            remote_src: yes
            owner: root
            group: root
            mode: '0600'
      when: not node_joined

    - name: Verify node joined successfully
      command: kubectl get nodes {{ inventory_hostname }} -o wide
      register: final_status
      delegate_to: "{{ groups['masters'][0] }}"

    - name: Display final status
      debug:
        var: final_status.stdout